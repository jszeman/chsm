{% for name in data.template_params.include_list %}
#include "{{ name }}"
{% endfor %}

{% for state_id, state in data.states.items() | sort(attribute='title') if state.type == 'normal' %}
static {{data.template_params.func_return_type}} {{ state.title }}({{data.template_params.func_params}});
{% endfor %}

{% for state_id, state in data.states.items() | sort(attribute='title') if state.type == 'normal' %}
static {{data.template_params.func_return_type}} {{ state.title }}({{data.template_params.func_params}})
{
    switch({{data.template_params.switch_variable}})
    {
        {% for signal_id in state.signals.keys() | reject('in', [None, 'entry', 'exit', 'init']) | sort %}
        {% set signal = state.signals[signal_id] %}
        case {{data.template_params.signal_prefix}}{{signal_id}}:
            {% for (guard_func, guard_param), guard in signal.guards.items() %}
                {% if not guard_func %}
                    {% for func, param in guard.funcs %}
            {{func}}({{data.template_params.func_args}}{% if param %}, {{param}}{% endif %});
                    {% endfor -%}
                {% if guard.target%}
                    {% if guard.target_type == 'call'%}
            return {{data.template_params.transition_func}}(self, {{guard.target_title}}({{data.template_params.func_args}}{% if guard.target_params %}, {{guard.target_params}}{% endif %}));
                    {% else %}
            return {{data.template_params.transition_func}}(self, {{guard.target_title}});
                    {% endif %}
                {% endif %}
                {% else %}
            if ({{guard_func}}({{data.template_params.func_args}}{% if guard_param %}, {{guard_param}}{% endif %}))
            {
                {% for func, param in guard.funcs %}
                {{func}}({{data.template_params.func_args}}{% if param %}, {{param}}{% endif %});
                {% endfor %}
                {% if guard.target %}
                    {% if guard.target_type == 'call'%}
                return {{data.template_params.transition_func}}(self, {{guard.target_title}}({{data.template_params.func_args}}{% if guard.target_params %}, {{guard.target_params}}{% endif %}));
                    {% else %}
                return {{data.template_params.transition_func}}(self, {{guard.target_title}});
                    {% endif %}
                {% endif %}
            }
                {% endif %}
            {% endfor %}
            {% if (None, None) not in signal.guards or not signal.guards[(None, None)].target %}
            break;
            {% endif %}

        {% endfor %}
    }
    {% for (guard_func, guard_param), guard in state.signals[None].guards.items() %}
        {% if  guard_func %}

    if ({{guard_func}}({{data.template_params.func_args}}{% if guard_param %}, {{guard_param}}{% endif %}))
    {
        {% for func, param in guard.funcs %}
        {{func}}({{data.template_params.func_args}}{% if param %}, {{param}}{% endif %});
        {% endfor %}
        {% if guard.target %}
        return {{data.template_params.transition_func}}(self, {{guard.target_title}});
        {% endif %}
    }
        {% endif %}
    {% endfor %}

    return{% if data.template_params.ignore_func %} {{data.template_params.ignore_func}}(self){% endif%};
}

{% endfor %}

{{data.template_params.func_return_type}} {{ data.template_params.top_func }}({{data.template_params.func_params}})
{
    switch({{data.template_params.switch_variable}})
    {
        case {{data.template_params.init_signal}}:
                    {% for func, param in data.states.__top__.signals.init.guards[(None, None)].funcs %}
                        {% if func %}
            {{func}}({{data.template_params.func_args}}{% if param %}, {{param}}{% endif %});
                        {% endif %}
                    {% endfor %}
            return {{data.template_params.transition_func}}(self, {{data.states.__top__.signals.init.guards[(None, None)].target_title}});
    }

    return{% if data.template_params.ignore_func %} {{data.template_params.ignore_func}}(self){% endif%};
}
